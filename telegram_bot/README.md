# Telegram Bot для реферальной системы

## Описание

Этот Telegram бот интегрирован с PostgreSQL базой данных (через Supabase) и обеспечивает функциональность реферальной системы для веб-приложения.

## Архитектура

- `main.py` - основной файл бота, обрабатывающий команды и сообщения
- `database.py` - модуль для работы с PostgreSQL базой данных
- `schema.sql` - SQL-схема базы данных
- `requirements.txt` - зависимости проекта

## Установка и запуск

### Требования

- Python 3.8+
- PostgreSQL (или Supabase аккаунт)

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Настройка окружения

Создайте файл `.env` в корне проекта:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_бота_от_BotFather
SUPABASE_DATABASE_URL=ваша_строка_подключения_к_supabase
WEBAPP_URL=https://ваш-домен.com
```

### Применение схемы базы данных

Выполните SQL-скрипт из файла `schema.sql` в вашей PostgreSQL базе данных.

### Запуск бота

```bash
python -m telegram_bot.main
```

## Функциональность

### Обработка команды /start

- Бот обрабатывает команду `/start` с параметрами
- Если передан реферальный код, бот устанавливает связи между пользователями
- Новые пользователи регистрируются в системе с привязкой к рефереру (если есть)

### Интеграция с WebApp

- Бот предоставляет inline-кнопку для открытия WebApp
- При открытии WebApp передается реферальный параметр для корректной идентификации

### Управление пользователями

- Регистрация новых пользователей
- Обновление данных существующих пользователей
- Управление реферальными связями

## Структура базы данных

### Основные таблицы:

- `profiles` - профили пользователей
- `referrals` - реферальные связи
- `balances` - балансы пользователей
- `user_stats` - статистика пользователей
- `referral_stats` - статистика по рефералам
- `subscriptions` - подписки пользователей
- `vpn_keys` - VPN ключи
- `telegram_channels` - телеграм каналы пользователей
- `user_bots` - боты пользователей
- `user_roles` - роли пользователей
- `support_tickets` - заявки в поддержку

## Производительность

- Используется асинхронное подключение к базе данных через asyncpg
- Создается пул соединений для эффективной работы с БД
- Применены индексы для ускорения частых запросов