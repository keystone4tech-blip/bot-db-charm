# Telegram Бот для реферальной системы

## Описание

Этот Telegram бот интегрирован с PostgreSQL базой данных (через Supabase) и обеспечивает функциональность реферальной системы для веб-приложения.

## Архитектура

- `bot_instance.py` - экземпляр бота
- `dispatcher.py` - диспетчер обработки сообщений
- `main.py` - основной файл запуска бота
- `database/` - модули для работы с базой данных
 - `database_manager.py` - основной класс для работы с БД
- `handlers/` - обработчики команд и сообщений
 - `komanda_start.py` - обработчик команды /start
- `keyboards/` - модули клавиатур
  - `webapp_knopka.py` - клавиатура для открытия WebApp
- `middlewares/` - папка для middleware
- `states/` - папка для FSM состояний
- `utils/` - папка для утилит

## Установка и запуск

### Требования

- Python 3.8+
- PostgreSQL (или Supabase аккаунт)

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Настройка окружения

Используется файл `.env` в корне проекта:

```env
BOT_TOKEN=ваш_токен_бота_от_BotFather
ADMIN_IDS=238264393

# Настройки базы данных PostgreSQL
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=ваш_пароль_от_postgres
DB_NAME=ваше_имя_базы_данных
WEBAPP_URL=https://ваш-домен.com
```

### Применение схемы базы данных

Выполните SQL-скрипт из файла `telegram_bot/schema.sql` в вашей PostgreSQL базе данных.

### Запуск бота

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Убедитесь, что в корне проекта есть файл `.env` с необходимыми переменными:
```env
BOT_TOKEN=ваш_токен_бота_от_BotFather
ADMIN_IDS=238264393

# Настройки базы данных PostgreSQL
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=ваш_пароль_от_postgres
DB_NAME=ваше_имя_базы_данных
WEBAPP_URL=https://ваш-домен.com
```

3. Запустите бота:
```bash
python run_bot.py
```

## Функциональность

### Обработка команды /start

- Бот обрабатывает команду `/start` с параметрами
- Если передан реферальный код, бот устанавливает связи между пользователями
- Новые пользователи регистрируются в системе с привязкой к рефереру (если есть)

### Интеграция с WebApp

- Бот предоставляет inline-кнопку для открытия WebApp
- При открытии WebApp передается реферальный параметр для корректной идентификации

### Управление пользователями

- Регистрация новых пользователей
- Обновление данных существующих пользователей
- Управление реферальными связями

## Структура базы данных

### Основные таблицы:

- `profiles` - профили пользователей
- `referrals` - реферальные связи
- `balances` - балансы пользователей
- `user_stats` - статистика пользователей
- `referral_stats` - статистика по рефералам
- `subscriptions` - подписки пользователей
- `vpn_keys` - VPN ключи
- `telegram_channels` - телеграм каналы пользователей
- `user_bots` - боты пользователей
- `user_roles` - роли пользователей
- `support_tickets` - заявки в поддержку

## Производительность

- Используется асинхронное подключение к базе данных через asyncpg
- Создается пул соединений для эффективной работы с БД
- Применены индексы для ускорения частых запросов