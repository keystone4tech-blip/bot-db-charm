# Архитектура взаимодействия компонентов приложения

## Общая структура

Приложение состоит из трех основных компонентов:
1. **Frontend** (React/Vite) - веб-интерфейс для пользователей
2. **Backend** (Node.js/Express) - API сервер для обработки запросов
3. **Telegram Bot** (Python/Aiogram) - бот для взаимодействия с пользователями в Telegram

Все три компонента используют общую базу данных PostgreSQL для хранения данных.

## Взаимодействие между компонентами

### 1. Frontend ↔ PostgreSQL (через Supabase Functions)
- Frontend использует Supabase Functions для аутентификации и получения данных
- Вызовы функций происходят через API endpoint: `/functions/v1/telegram-auth`
- Используется анонимный ключ (anon key) с RLS политиками
- Доступ только к своим данным (ограничено политиками RLS)

### 2. Backend ↔ PostgreSQL
- Backend (Node.js сервер) использует сервисный ключ (service role key) для прямого доступа к базе данных
- Имеет полный доступ ко всем данным ( bypass RLS политик)
- Обрабатывает аутентификацию пользователей и создание записей
- Использует библиотеку `pg` для подключения к PostgreSQL

### 3. Telegram Bot ↔ PostgreSQL (через Supabase Client)
- Telegram Bot использует Supabase Client с сервисным ключом (service role key)
- Имеет полный доступ ко всем данным (bypass RLS политик)
- Обрабатывает регистрацию пользователей и обновление статусов
- Использует библиотеку `supabase` для подключения к базе данных

## Настройка доступа к базе данных

### Frontend (публичный доступ)
- Использует анонимный ключ (anon key)
- Ограничен RLS политиками (доступ только к своим данным)
- Разрешены операции: SELECT, INSERT (свои данные), UPDATE (свои данные)
- Запрещены операции: DELETE (чужие данные), UPDATE (чужие данные)

### Backend и Bot (полный доступ)
- Используют сервисный ключ (service role key)
- Полный доступ ко всем данным (bypass RLS политик)
- Разрешены все операции: SELECT, INSERT, UPDATE, DELETE (все данные)
- Используются для административных задач и обновления данных

## Переменные окружения

### Для Frontend:
- `VITE_SUPABASE_URL` - URL к Supabase проекту
- `VITE_SUPABASE_PUBLISHABLE_KEY` - Публичный ключ для аутентификации
- `VITE_SERVER_BASE_URL` - URL к Node.js серверу (если используется)

### Для Backend:
- `SUPABASE_URL` - URL к Supabase проекту
- `SUPABASE_SERVICE_ROLE_KEY` - Сервисный ключ для полного доступа
- `TELEGRAM_BOT_TOKEN` - Токен Telegram бота (для взаимодействия с ботом)

### Для Telegram Bot:
- `SUPABASE_URL` - URL к Supabase проекту
- `SUPABASE_SERVICE_ROLE_KEY` - Сервисный ключ для полного доступа
- `BOT_TOKEN` - Токен Telegram бота

## Безопасность

1. **RLS (Row Level Security)** - ограничивает доступ к данным на уровне строк
2. **Разные ключи доступа** - анонимный для frontend, сервисный для backend/bot
3. **Проверка аутентификации** - все запросы проверяются на подлинность
4. **Валидация данных** - все входящие данные проверяются на корректность

## Структура таблиц

Все таблицы используют UUID в качестве первичного ключа и связаны между собой через внешние ключи.

## Миграции

При локальной установке PostgreSQL:
1. Создать базу данных
2. Выполнить SQL из schema.sql
3. Настроить RLS политики
4. Запустить приложение с соответствующими переменными окружения

## Рекомендации по деплою

1. **Для локального запуска** - использовать локальный PostgreSQL сервер
2. **Для продакшена** - использовать Supabase или облачный PostgreSQL
3. **Хранить ключи безопасности** - использовать безопасные способы хранения ключей (secrets)
4. **Мониторинг и логирование** - включить логирование всех операций с базой данных